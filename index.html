<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>Today’s Steel News</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href='https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css' rel='stylesheet' />
  <style>
    body, html {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Arial', sans-serif;
      background: rgba(0, 0, 0, 0.5) url('https://api.mapbox.com/styles/v1/mapbox/satellite-v9/static/0,0,1/800x600?access_token=pk.eyJ1IjoiaGFydWNoYW5uIiwiYSI6ImNsdnFlZWRidTAyNmkya21yem1wMjhzZHUifQ.GrEXJlVvv0ljdkQXoEQTTQ') no-repeat center center fixed;
      background-blend-mode: darken;
      background-size: cover;
    }
    #header, #footer {
      width: 100%;
      padding: 10px;
      background: #333;
      color: #fff;
      text-align: center;
      font-size: 15px;
    }
    #footer {
      position: fixed;
      bottom: 0;
    }
    #menu {
      width: 100%;
      padding: 10px 0;
      background: #555;
      color: #fff;
      text-align: center;
    }
    #menu a {
      margin: 0 10px;
      color: #fff;
      text-decoration: none;
    }
    #container {
      display: flex;
      flex-direction: column;
      height: calc(100% - 100px); /* Adjusted for header and footer height */
      overflow: hidden;
      position: relative;
    }
    #news-sections {
      padding: 10px;
      overflow-y: auto;
      flex: 1;
    }
    .section {
      margin-bottom: 20px;
    }
    .section-title {
      font-size: 18px;
      margin-bottom: 10px;
      color: #fff; /* Changed to white */
    }
    .news-item {
      padding: 10px;
      border: 1px solid #ddd;
      background-color: #fff;
      margin-bottom: 10px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .news-item:hover {
      background-color: #eee;
    }
    .news-content-small {
      font-size: 12px;
      color: #666;
      display: block;
      margin-top: 5px;
    }
    .news-content {
      display: none;
      padding: 10px;
      box-sizing: border-box;
      background-color: #ffffff;
    }
    .button {
      display: inline-block;
      padding: 5px 10px;
      margin-top: 10px;
      background-color: #333;
      color: #fff;
      text-align: center;
      cursor: pointer;
      border: none;
      border-radius: 5px;
    }
    #map {
      width: 100%;
      height: 50%; /* Adjusted height to show map and content */
      display: none;
    }
    #satellite-content {
      padding: 10px;
      height: 50%; /* Adjusted height to show map and content */
      overflow-y: auto;
      display: none;
      background-color: #fff;
    }
    .comment-section {
      margin-top: 20px;
    }
    .comment-form {
      display: flex;
      flex-direction: column;
    }
    .comment-form input,
    .comment-form textarea {
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-family: 'Arial', sans-serif; /* Ensures same font-family */
    }
    .comment-form textarea {
      font-size: 14px; /* Same font-size as input */
    }
    .comment-form button {
      padding: 10px;
      background-color: #333;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .comments {
      margin-top: 10px;
      max-height: 100px; /* Make the comment section smaller */
      overflow-y: auto; /* Add scroll if comments overflow */
    }
    .comment {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      font-size: 14px; /* Smaller font-size for comments */
    }
  </style>
</head>
<body>
  <div id="header">Today’s Steel News</div>
  <div id="menu">
    <a href="#" onclick="showSection('today')">Today's News</a>
    <a href="#" onclick="showSection('past')">Past News</a>
    <a href="#" onclick="showSection('satellite')">Satellite Image</a>
  </div>
  <div id="container">
    <div id="news-sections" data-section="today">
      <div class="section" id="produce">
        <div class="section-title">Produce</div>
      </div>
      <div class="section" id="decarbonization">
        <div class="section-title">Decarbonization</div>
      </div>
      <div class="section" id="trade">
        <div class="section-title">Trade</div>
      </div>
      <div class="section" id="other">
        <div class="section-title">Other</div>
      </div>
    </div>
    <div id="news-sections" data-section="past" style="display: none;">
      <div class="section-title">Past News</div>
      <!-- Past news will be dynamically populated here -->
    </div>
    <div id="map" data-section="satellite" style="display: none;"></div>
    <div id="satellite-content"></div> <!-- Added for content display -->
  </div>
  <div id="footer">© 2024 Steel News Satellite</div>

  <script src='https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js'></script>
  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiaGFydWNoYW5uIiwiYSI6ImNsdnFlZWRidTAyNmkya21yem1wMjhzZHUifQ.GrEXJlVvv0ljdkQXoEQTTQ';
    const map = new mapboxgl.Map({
      container: 'map', // container ID
      style: 'mapbox://styles/mapbox/satellite-v9', // style URL
      center: [31.261181743597245,30.033253480264698], // initial center coordinates
      zoom: 1.9, // initial zoom
      pitch: 0, // pitch in degrees
      bearing: 0 // bearing in degrees
    });

    map.addControl(new mapboxgl.NavigationControl());

    let isSpinning = true;

    map.on('style.load', () => {
      map.setFog({}); // Set the default atmosphere style
      spinGlobe();
    });

    let activeContentDiv = null;

    const newsArticles = [
      {
        title: "Vietnam targets higher steel output, lower emissions",
        date: "05/13/2024",
        content: "Vietnam could produce 51 million tonnes of crude steel in 2050, Vietnam Steel Association (VSA) secretary general and vice chairman Dinh Quoc Thai said at Monday’s South East Asian Iron and Steel Institute (Seaisi) annual conference.",
        location: [105.8148158587074,21.01580842214596],
        category: "produce"
      },
      {
        title: "ArcelorMittal Restocking Outlook",
        date: "05/03/2024",
        content: "ArcelorMittal observes a waiting period for a rebound in restocking. Sentiment stabilizes, awaiting consumption increase due to low inventory levels. Maintains global steel demand growth forecast for 2024. Q1 shows declines in production, shipments, net profit, and Ebitda, but revenue grows compared to Q4 2023. European steel spreads improve, US prices stabilize influenced by low inventory. Challenges noted from China’s excess steel production and rising exports. Focus on upcoming projects for low-emission steel supply.",
        location: [6.143465193777926,49.62180385642374],
        category: "trade"
      }
    ];

    const sections = {
      produce: document.getElementById('produce'),
      decarbonization: document.getElementById('decarbonization'),
      trade: document.getElementById('trade'),
      other: document.getElementById('other')
    };

    function loadComments() {
      const commentsData = JSON.parse(localStorage.getItem('commentsData')) || {};
      newsArticles.forEach(article => {
        const commentsSectionToday = document.querySelector(`.comments[data-title="${article.title}"]`);
        const commentsSectionPast = document.querySelector(`.comments[data-title-past="${article.title}"]`);
        const articleComments = commentsData[article.title] || [];
        articleComments.forEach(comment => {
          const commentDiv = document.createElement('div');
          commentDiv.className = 'comment';
          commentDiv.innerHTML = `<strong>${comment.name}:</strong> ${comment.text}`;
          if (commentsSectionToday) {
            commentsSectionToday.appendChild(commentDiv.cloneNode(true));
          }
          if (commentsSectionPast) {
            commentsSectionPast.appendChild(commentDiv.cloneNode(true));
          }
        });
      });
    }

    function saveComment(title, name, text) {
      const commentsData = JSON.parse(localStorage.getItem('commentsData')) || {};
      if (!commentsData[title]) {
        commentsData[title] = [];
      }
      commentsData[title].push({ name, text });
      localStorage.setItem('commentsData', JSON.stringify(commentsData));
    }

    newsArticles.forEach(article => {
      const newsItem = document.createElement('div');
      newsItem.className = 'news-item';
      newsItem.innerHTML = `${article.title}<span class="news-content-small">${article.content}</span>`;
      const contentDiv = document.createElement('div');
      contentDiv.className = 'news-content';
      contentDiv.innerHTML = `
        <button class="button" onclick='zoomToImage(${JSON.stringify(article.location)}, "${article.content}")'>Detail Image</button>
        <button class="button" onclick="showFullContent('${article.content}')">Detail Content</button>
        <div class="comment-section">
          <form class="comment-form" onsubmit="submitComment(this, '${article.title}'); return false;">
            <input type="text" placeholder="Your name..." required>
            <textarea rows="2" placeholder="Write your comment..." required></textarea>
            <button type="submit" class="button">Submit</button>
          </form>
          <div class="comments" data-title="${article.title}"></div>
        </div>
      `;
      newsItem.appendChild(contentDiv);
      newsItem.addEventListener('click', (event) => {
        if (!event.target.closest('.news-content')) {
          if (activeContentDiv && activeContentDiv !== contentDiv) {
            activeContentDiv.style.display = 'none';
          }
          contentDiv.style.display = contentDiv.style.display === 'none' ? 'block' : 'none';
          activeContentDiv = contentDiv.style.display === 'block' ? contentDiv : null;
        }
      });
      sections[article.category].appendChild(newsItem);

      // Add to past news
      const pastNewsSection = document.querySelector('[data-section="past"]');
      const pastNewsItem = newsItem.cloneNode(true);
      pastNewsItem.querySelector('.comment-form').onsubmit = function() { submitComment(this, article.title); return false; };
      pastNewsItem.querySelectorAll('.button')[0].onclick = function() { zoomToImage(article.location, article.content); };
      pastNewsItem.querySelectorAll('.button')[1].onclick = function() { showFullContent(article.content); };
      pastNewsItem.querySelector('.comments').setAttribute('data-title-past', article.title);
      pastNewsSection.appendChild(pastNewsItem);
    });

    function zoomToImage(location, content) {
      if (isSpinning) {
        isSpinning = false;
      }
      
      map.flyTo({
        center: location,
        zoom: 15,
        essential: true
      });

      map.once('moveend', () => {
        document.getElementById('map').style.display = 'block';
        document.getElementById('satellite-content').style.display = 'block';
        document.getElementById('satellite-content').innerText = content;
      });

      showSection('satellite');
    }

    function showFullContent(content) {
      alert(content); // Change this to a more sophisticated modal if needed
    }

    function showSection(section) {
      document.querySelectorAll('[data-section]').forEach(el => el.style.display = 'none');
      document.querySelector(`[data-section="${section}"]`).style.display = 'block';

      if (section !== 'satellite') {
        document.getElementById('satellite-content').style.display = 'none';
      }
    }

    function submitComment(form, title) {
      const name = form.querySelector('input').value.trim();
      const commentText = form.querySelector('textarea').value.trim();
      if (name === '' || commentText === '') return;

      // Display comment immediately after submission
      const comment = document.createElement('div');
      comment.className = 'comment';
      comment.innerHTML = `<strong>${name}:</strong> ${commentText}`;
      const commentsSection = form.nextElementSibling;
      commentsSection.appendChild(comment);

      // Save comment to local storage
      saveComment(title, name, commentText);

      // Clear form fields after submission
      form.querySelector('input').value = '';
      form.querySelector('textarea').value = '';
    }

    function spinGlobe() {
      const secondsPerRevolution = 120;

      function rotateGlobe() {
        if (!isSpinning) return;

        const distancePerSecond = 360 / secondsPerRevolution;
        const center = map.getCenter();
        center.lng -= distancePerSecond;
        map.easeTo({ center, duration: 1000, easing: (n) => n });

        if (isSpinning) {
          requestAnimationFrame(rotateGlobe);
        }
      }
      rotateGlobe();
    }

    // Load comments from local storage when the page loads ma
    document.addEventListener('DOMContentLoaded', loadComments);
  </script>
</body>
</html>
